<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Sampling Distribution Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            display: flex;
            min-height: 700px;
        }

        .sidebar {
            width: 380px;
            background: #f8f9fa;
            padding: 25px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .main-panel {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #7e22ce;
            box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(126, 34, 206, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chart-container canvas {
            height: 300px !important;
        }

        .sample-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chart-section {
            margin-bottom: 20px;
            min-height: 0;
        }

        .chart-section:last-of-type {
            margin-bottom: 15px;
        }

        .chart-section canvas {
            max-height: 180px !important;
            height: 180px !important;
        }

        .section-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e0e0e0;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 18px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .info-box p {
            color: #555;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        .stats-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px;
            border-radius: 10px;
            margin-top: 5px;
            border: 1px solid #dee2e6;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .stats-row:last-child {
            margin-bottom: 0;
        }

        .stats-label {
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .stats-value {
            color: #7e22ce;
            font-weight: 700;
            font-size: 1.05em;
        }

        .dynamic-inputs {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 18px;
            border: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: none;
            }
            .sample-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bootstrap Sampling Distribution Simulator</h1>
            <p>Approximate sampling distributions using bootstrap resampling</p>
        </div>

        <div class="content">
            <div class="sidebar">
                <div class="info-box">
                    <h3>Bootstrap Method</h3>
                    <p>Draw samples with replacement from original data to approximate the sampling distribution of any statistic.</p>
                </div>

                <div class="form-group">
                    <label for="distribution">Population Distribution</label>
                    <select id="distribution">
                        <option value="normal">Normal</option>
                        <option value="uniform">Uniform</option>
                        <option value="exponential">Exponential</option>
                        <option value="gamma">Gamma</option>
                        <option value="beta">Beta</option>
                        <option value="weibull">Weibull</option>
                        <option value="lognormal">Log-Normal</option>
                        <option value="chisquare">Chi-Square</option>
                        <option value="t">Student's t</option>
                        <option value="f">F-Distribution</option>
                        <option value="bimodal">Bimodal</option>
                        <option value="skewed">Highly Skewed</option>
                        <option value="binomial">Binomial</option>
                        <option value="poisson">Poisson</option>
                        <option value="negbinom">Negative Binomial</option>
                    </select>
                </div>

                <div id="dynamicInputs" class="dynamic-inputs"></div>

                <div class="form-group">
                    <label for="statistic">Estimator/Statistic</label>
                    <select id="statistic">
                        <option value="mean">Mean</option>
                        <option value="median">Median</option>
                        <option value="variance">Variance</option>
                        <option value="sd">Standard Deviation</option>
                        <option value="mad">Median Absolute Deviation</option>
                        <option value="iqr">Interquartile Range</option>
                        <option value="trimmedMean10">10% Trimmed Mean</option>
                        <option value="trimmedMean20">20% Trimmed Mean</option>
                        <option value="skewness">Skewness</option>
                        <option value="kurtosis">Kurtosis</option>
                        <option value="cv">Coefficient of Variation</option>
                        <option value="range">Range</option>
                        <option value="q25">25th Percentile</option>
                        <option value="q75">75th Percentile</option>
                        <option value="max">Maximum</option>
                        <option value="min">Minimum</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sampleSize">Sample Size (n)</label>
                    <input type="number" id="sampleSize" value="50" min="10" step="10">
                </div>

                <div class="form-group">
                    <label for="numBootstrap">Bootstrap Samples (B)</label>
                    <input type="number" id="numBootstrap" value="1000" min="100" step="100">
                </div>

                <div class="form-group">
                    <label for="numSamples">Number of Original Samples to Compare</label>
                    <input type="number" id="numSamples" value="3" min="1" max="6" step="1">
                </div>

                <div class="form-group">
                    <label for="numBins">Number of Histogram Bins</label>
                    <input type="number" id="numBins" value="30" min="10" max="50" step="5">
                </div>

                <div class="form-group">
                    <label for="numTrueSamples">True Sampling Distribution Samples</label>
                    <input type="number" id="numTrueSamples" value="5000" min="1000" step="1000">
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="simulate()">Simulate</button>
                    <button class="btn-secondary" onclick="reset()">Reset</button>
                </div>
            </div>

            <div class="main-panel">
                <div class="chart-container">
                    <div class="chart-title">True Sampling Distribution (from population)</div>
                    <canvas id="trueSamplingChart"></canvas>
                    <div id="trueStats" class="stats-display"></div>
                </div>

                <div id="sampleCharts" class="sample-grid"></div>
            </div>
        </div>
    </div>

    <script>
        let trueSamplingChart = null;
        let sampleCharts = [];

        // Statistical functions
        function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function median(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function variance(arr) {
            const m = mean(arr);
            return arr.reduce((sum, x) => sum + Math.pow(x - m, 2), 0) / (arr.length - 1);
        }

        function sd(arr) {
            return Math.sqrt(variance(arr));
        }

        function mad(arr) {
            const med = median(arr);
            const deviations = arr.map(x => Math.abs(x - med));
            return median(deviations);
        }

        function quantile(arr, p) {
            const sorted = [...arr].sort((a, b) => a - b);
            const pos = (sorted.length - 1) * p;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (sorted[base + 1] !== undefined) {
                return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
            }
            return sorted[base];
        }

        function iqr(arr) {
            return quantile(arr, 0.75) - quantile(arr, 0.25);
        }

        function trimmedMean(arr, proportion) {
            const sorted = [...arr].sort((a, b) => a - b);
            const trimCount = Math.floor(sorted.length * proportion);
            const trimmed = sorted.slice(trimCount, sorted.length - trimCount);
            return mean(trimmed);
        }

        function skewness(arr) {
            const m = mean(arr);
            const s = sd(arr);
            const n = arr.length;
            const sum = arr.reduce((acc, x) => acc + Math.pow((x - m) / s, 3), 0);
            return (n / ((n - 1) * (n - 2))) * sum;
        }

        function kurtosis(arr) {
            const m = mean(arr);
            const s = sd(arr);
            const n = arr.length;
            const sum = arr.reduce((acc, x) => acc + Math.pow((x - m) / s, 4), 0);
            return ((n * (n + 1)) / ((n - 1) * (n - 2) * (n - 3))) * sum -
                   (3 * Math.pow(n - 1, 2)) / ((n - 2) * (n - 3));
        }

        function cv(arr) {
            return sd(arr) / mean(arr);
        }

        function computeStatistic(arr, stat) {
            switch(stat) {
                case 'mean': return mean(arr);
                case 'median': return median(arr);
                case 'variance': return variance(arr);
                case 'sd': return sd(arr);
                case 'mad': return mad(arr);
                case 'iqr': return iqr(arr);
                case 'trimmedMean10': return trimmedMean(arr, 0.1);
                case 'trimmedMean20': return trimmedMean(arr, 0.2);
                case 'skewness': return skewness(arr);
                case 'kurtosis': return kurtosis(arr);
                case 'cv': return cv(arr);
                case 'range': return Math.max(...arr) - Math.min(...arr);
                case 'q25': return quantile(arr, 0.25);
                case 'q75': return quantile(arr, 0.75);
                case 'max': return Math.max(...arr);
                case 'min': return Math.min(...arr);
            }
        }

        // Random number generators
        function randomNormal(mean, sd) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return mean + sd * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function randomExponential(rate) {
            return -Math.log(1 - Math.random()) / rate;
        }

        function randomGamma(alpha, beta = 1) {
            if (alpha < 1) {
                const u = Math.random();
                return randomGamma(1 + alpha, beta) * Math.pow(u, 1 / alpha);
            }

            const d = alpha - 1 / 3;
            const c = 1 / Math.sqrt(9 * d);

            while (true) {
                let x, v;
                do {
                    x = randomNormal(0, 1);
                    v = 1 + c * x;
                } while (v <= 0);

                v = v * v * v;
                const u = Math.random();
                if (u < 1 - 0.0331 * x * x * x * x) return d * v / beta;
                if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) return d * v / beta;
            }
        }

        function randomBeta(alpha, beta) {
            const x = randomGamma(alpha);
            const y = randomGamma(beta);
            return x / (x + y);
        }

        function randomWeibull(shape, scale) {
            return scale * Math.pow(-Math.log(1 - Math.random()), 1 / shape);
        }

        function randomLogNormal(meanLog, sdLog) {
            return Math.exp(randomNormal(meanLog, sdLog));
        }

        function randomChiSquare(df) {
            return randomGamma(df / 2, 0.5);
        }

        function randomT(df) {
            const z = randomNormal(0, 1);
            const chi = randomChiSquare(df);
            return z / Math.sqrt(chi / df);
        }

        function randomF(df1, df2) {
            const chi1 = randomChiSquare(df1);
            const chi2 = randomChiSquare(df2);
            return (chi1 / df1) / (chi2 / df2);
        }

        function randomBinomial(n, p) {
            let successes = 0;
            for (let i = 0; i < n; i++) {
                if (Math.random() < p) successes++;
            }
            return successes;
        }

        function randomPoisson(lambda) {
            const L = Math.exp(-lambda);
            let k = 0;
            let p = 1;
            do {
                k++;
                p *= Math.random();
            } while (p > L);
            return k - 1;
        }

        function randomNegativeBinomial(r, p) {
            let failures = 0;
            let successes = 0;
            while (successes < r) {
                if (Math.random() < p) {
                    successes++;
                } else {
                    failures++;
                }
            }
            return failures;
        }

        function sampleFromDistribution(dist, params) {
            switch(dist) {
                case 'normal':
                    return randomNormal(params.mean, params.sd);
                case 'uniform':
                    return params.min + Math.random() * (params.max - params.min);
                case 'exponential':
                    return randomExponential(params.rate);
                case 'gamma':
                    return randomGamma(params.shape, params.rate);
                case 'beta':
                    return randomBeta(params.alpha, params.beta);
                case 'weibull':
                    return randomWeibull(params.shape, params.scale);
                case 'lognormal':
                    return randomLogNormal(params.meanlog, params.sdlog);
                case 'chisquare':
                    return randomChiSquare(params.df);
                case 't':
                    return randomT(params.df);
                case 'f':
                    return randomF(params.df1, params.df2);
                case 'bimodal':
                    if (Math.random() < params.prop) {
                        return randomNormal(params.mean1, params.sd1);
                    }
                    return randomNormal(params.mean2, params.sd2);
                case 'skewed':
                    return randomGamma(params.shape, params.rate);
                case 'binomial':
                    return randomBinomial(params.n, params.p);
                case 'poisson':
                    return randomPoisson(params.lambda);
                case 'negbinom':
                    return randomNegativeBinomial(params.r, params.p);
            }
        }

        function updateDynamicInputs() {
            const dist = document.getElementById('distribution').value;
            const container = document.getElementById('dynamicInputs');

            let html = '';

            switch(dist) {
                case 'normal':
                    html = `
                        <div class="form-group">
                            <label for="mean">Mean (μ)</label>
                            <input type="number" id="mean" value="100" step="1">
                        </div>
                        <div class="form-group">
                            <label for="sd">SD (σ)</label>
                            <input type="number" id="sd" value="15" step="1">
                        </div>
                    `;
                    break;
                case 'uniform':
                    html = `
                        <div class="form-group">
                            <label for="min">Minimum</label>
                            <input type="number" id="min" value="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="max">Maximum</label>
                            <input type="number" id="max" value="100" step="1">
                        </div>
                    `;
                    break;
                case 'exponential':
                    html = `
                        <div class="form-group">
                            <label for="rate">Rate (λ)</label>
                            <input type="number" id="rate" value="1" step="0.1">
                        </div>
                    `;
                    break;
                case 'gamma':
                case 'skewed':
                    html = `
                        <div class="form-group">
                            <label for="shape">Shape (k)</label>
                            <input type="number" id="shape" value="2" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="rate">Rate (θ)</label>
                            <input type="number" id="rate" value="2" step="0.1">
                        </div>
                    `;
                    break;
                case 'beta':
                    html = `
                        <div class="form-group">
                            <label for="alpha">Alpha (α)</label>
                            <input type="number" id="alpha" value="2" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="beta">Beta (β)</label>
                            <input type="number" id="beta" value="5" step="0.5">
                        </div>
                    `;
                    break;
                case 'weibull':
                    html = `
                        <div class="form-group">
                            <label for="shape">Shape (k)</label>
                            <input type="number" id="shape" value="1.5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="scale">Scale (λ)</label>
                            <input type="number" id="scale" value="1" step="0.1">
                        </div>
                    `;
                    break;
                case 'lognormal':
                    html = `
                        <div class="form-group">
                            <label for="meanlog">Mean of log</label>
                            <input type="number" id="meanlog" value="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="sdlog">SD of log</label>
                            <input type="number" id="sdlog" value="0.5" step="0.1">
                        </div>
                    `;
                    break;
                case 'chisquare':
                    html = `
                        <div class="form-group">
                            <label for="df">Degrees of Freedom</label>
                            <input type="number" id="df" value="5" min="1" step="1">
                        </div>
                    `;
                    break;
                case 't':
                    html = `
                        <div class="form-group">
                            <label for="df">Degrees of Freedom</label>
                            <input type="number" id="df" value="10" min="1" step="1">
                        </div>
                    `;
                    break;
                case 'f':
                    html = `
                        <div class="form-group">
                            <label for="df1">DF1</label>
                            <input type="number" id="df1" value="5" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="df2">DF2</label>
                            <input type="number" id="df2" value="10" min="1" step="1">
                        </div>
                    `;
                    break;
                case 'bimodal':
                    html = `
                        <div class="form-group">
                            <label for="mean1">Mean 1</label>
                            <input type="number" id="mean1" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label for="sd1">SD 1</label>
                            <input type="number" id="sd1" value="5" step="1">
                        </div>
                        <div class="form-group">
                            <label for="mean2">Mean 2</label>
                            <input type="number" id="mean2" value="80" step="1">
                        </div>
                        <div class="form-group">
                            <label for="sd2">SD 2</label>
                            <input type="number" id="sd2" value="5" step="1">
                        </div>
                        <div class="form-group">
                            <label for="prop">Proportion in group 1</label>
                            <input type="number" id="prop" value="0.5" min="0" max="1" step="0.1">
                        </div>
                    `;
                    break;
                case 'binomial':
                    html = `
                        <div class="form-group">
                            <label for="n">Trials (n)</label>
                            <input type="number" id="n" value="20" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="p">Probability (p)</label>
                            <input type="number" id="p" value="0.3" min="0" max="1" step="0.1">
                        </div>
                    `;
                    break;
                case 'poisson':
                    html = `
                        <div class="form-group">
                            <label for="lambda">Lambda (λ)</label>
                            <input type="number" id="lambda" value="5" min="0.1" step="0.5">
                        </div>
                    `;
                    break;
                case 'negbinom':
                    html = `
                        <div class="form-group">
                            <label for="r">Successes (r)</label>
                            <input type="number" id="r" value="5" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="p">Probability (p)</label>
                            <input type="number" id="p" value="0.5" min="0" max="1" step="0.1">
                        </div>
                    `;
                    break;
            }

            container.innerHTML = html;
        }

        function getParams() {
            const dist = document.getElementById('distribution').value;
            const params = {};

            switch(dist) {
                case 'normal':
                    params.mean = parseFloat(document.getElementById('mean').value);
                    params.sd = parseFloat(document.getElementById('sd').value);
                    break;
                case 'uniform':
                    params.min = parseFloat(document.getElementById('min').value);
                    params.max = parseFloat(document.getElementById('max').value);
                    break;
                case 'exponential':
                    params.rate = parseFloat(document.getElementById('rate').value);
                    break;
                case 'gamma':
                case 'skewed':
                    params.shape = parseFloat(document.getElementById('shape').value);
                    params.rate = parseFloat(document.getElementById('rate').value);
                    break;
                case 'beta':
                    params.alpha = parseFloat(document.getElementById('alpha').value);
                    params.beta = parseFloat(document.getElementById('beta').value);
                    break;
                case 'weibull':
                    params.shape = parseFloat(document.getElementById('shape').value);
                    params.scale = parseFloat(document.getElementById('scale').value);
                    break;
                case 'lognormal':
                    params.meanlog = parseFloat(document.getElementById('meanlog').value);
                    params.sdlog = parseFloat(document.getElementById('sdlog').value);
                    break;
                case 'chisquare':
                    params.df = parseFloat(document.getElementById('df').value);
                    break;
                case 't':
                    params.df = parseFloat(document.getElementById('df').value);
                    break;
                case 'f':
                    params.df1 = parseFloat(document.getElementById('df1').value);
                    params.df2 = parseFloat(document.getElementById('df2').value);
                    break;
                case 'bimodal':
                    params.mean1 = parseFloat(document.getElementById('mean1').value);
                    params.sd1 = parseFloat(document.getElementById('sd1').value);
                    params.mean2 = parseFloat(document.getElementById('mean2').value);
                    params.sd2 = parseFloat(document.getElementById('sd2').value);
                    params.prop = parseFloat(document.getElementById('prop').value);
                    break;
                case 'binomial':
                    params.n = parseInt(document.getElementById('n').value);
                    params.p = parseFloat(document.getElementById('p').value);
                    break;
                case 'poisson':
                    params.lambda = parseFloat(document.getElementById('lambda').value);
                    break;
                case 'negbinom':
                    params.r = parseInt(document.getElementById('r').value);
                    params.p = parseFloat(document.getElementById('p').value);
                    break;
            }

            return params;
        }

        function createHistogram(data, numBins, globalMin = null, globalMax = null) {
            const min = globalMin !== null ? globalMin : Math.min(...data);
            const max = globalMax !== null ? globalMax : Math.max(...data);
            const binWidth = (max - min) / numBins;

            const bins = Array(numBins).fill(0);
            const binCenters = [];

            for (let i = 0; i < numBins; i++) {
                const binStart = min + i * binWidth;
                const binCenter = binStart + binWidth / 2;
                binCenters.push(binCenter);

                for (let val of data) {
                    if (val >= binStart && val < binStart + binWidth) {
                        bins[i]++;
                    } else if (i === numBins - 1 && val >= binStart && val <= max) {
                        bins[i]++;
                    }
                }
            }

            const normalizedBins = bins.map(count => count / (data.length * binWidth));

            return { bins: normalizedBins, centers: binCenters };
        }

        function bootstrap(sample, statFunc, B) {
            const bootstrapStats = [];
            const n = sample.length;

            for (let b = 0; b < B; b++) {
                const resample = [];
                for (let i = 0; i < n; i++) {
                    resample.push(sample[Math.floor(Math.random() * n)]);
                }
                bootstrapStats.push(statFunc(resample));
            }

            return bootstrapStats;
        }

        function simulate() {
            const dist = document.getElementById('distribution').value;
            const params = getParams();
            const stat = document.getElementById('statistic').value;
            const n = parseInt(document.getElementById('sampleSize').value);
            const B = parseInt(document.getElementById('numBootstrap').value);
            const numSamples = parseInt(document.getElementById('numSamples').value);
            const numBins = parseInt(document.getElementById('numBins').value);
            const numTrue = parseInt(document.getElementById('numTrueSamples').value);

            const statFunc = (arr) => computeStatistic(arr, stat);

            // Generate true sampling distribution
            const trueStats = [];
            for (let i = 0; i < numTrue; i++) {
                const sample = [];
                for (let j = 0; j < n; j++) {
                    sample.push(sampleFromDistribution(dist, params));
                }
                trueStats.push(statFunc(sample));
            }

            // Collect all stats to determine global scale
            let allStats = [...trueStats];

            // Pre-generate all bootstrap samples to determine global range
            const allBootstrapData = [];
            for (let s = 0; s < numSamples; s++) {
                const originalSample = [];
                for (let i = 0; i < n; i++) {
                    originalSample.push(sampleFromDistribution(dist, params));
                }
                const bootstrapStats = bootstrap(originalSample, statFunc, B);
                allBootstrapData.push({ originalSample, bootstrapStats });
                allStats = allStats.concat(bootstrapStats);
            }

            // Calculate global min and max with some padding
            const globalMin = Math.min(...allStats);
            const globalMax = Math.max(...allStats);
            const padding = (globalMax - globalMin) * 0.05;
            const paddedMin = globalMin - padding;
            const paddedMax = globalMax + padding;

            const trueHist = createHistogram(trueStats, numBins, paddedMin, paddedMax);

            // Update true sampling distribution chart
            if (!trueSamplingChart) {
                const ctx = document.getElementById('trueSamplingChart').getContext('2d');
                trueSamplingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: trueHist.centers.map(x => x.toFixed(3)),
                        datasets: [{
                            label: 'True Sampling Distribution',
                            data: trueHist.bins,
                            backgroundColor: 'rgba(30, 60, 114, 0.6)',
                            borderColor: '#1e3c72',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Density' }
                            },
                            x: {
                                title: { display: true, text: 'Statistic Value' }
                            }
                        }
                    }
                });
            } else {
                trueSamplingChart.data.labels = trueHist.centers.map(x => x.toFixed(3));
                trueSamplingChart.data.datasets[0].data = trueHist.bins;
                trueSamplingChart.update();
            }

            // Display true statistics
            const trueStatsHTML = `
                <div class="stats-row">
                    <span class="stats-label">True Mean:</span>
                    <span class="stats-value">${mean(trueStats).toFixed(4)}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">True SD:</span>
                    <span class="stats-value">${sd(trueStats).toFixed(4)}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">True SE:</span>
                    <span class="stats-value">${(sd(trueStats)).toFixed(4)}</span>
                </div>
            `;
            document.getElementById('trueStats').innerHTML = trueStatsHTML;

            // Generate individual samples and their bootstrap distributions
            const sampleChartsContainer = document.getElementById('sampleCharts');
            sampleChartsContainer.innerHTML = '';
            sampleCharts = [];

            for (let s = 0; s < numSamples; s++) {
                // Use pre-generated data
                const { originalSample, bootstrapStats } = allBootstrapData[s];
                const sampleStat = statFunc(originalSample);

                const bootHist = createHistogram(bootstrapStats, numBins, paddedMin, paddedMax);

                // Create chart container with two charts
                const chartDiv = document.createElement('div');
                chartDiv.className = 'sample-card';
                chartDiv.innerHTML = `
                    <div class="chart-title">Sample ${s + 1}</div>
                    <div class="chart-section">
                        <div class="section-title">Original Sample Distribution</div>
                        <canvas id="sampleDataChart${s}"></canvas>
                    </div>
                    <div class="chart-section">
                        <div class="section-title">Bootstrap Distribution of Statistic</div>
                        <canvas id="sampleChart${s}"></canvas>
                    </div>
                    <div id="sampleStats${s}" class="stats-display"></div>
                `;
                sampleChartsContainer.appendChild(chartDiv);

                // Create histogram of original sample data
                const dataHist = createHistogram(originalSample, Math.min(numBins, 25));
                const dataCtx = document.getElementById(`sampleDataChart${s}`).getContext('2d');
                const dataChart = new Chart(dataCtx, {
                    type: 'bar',
                    data: {
                        labels: dataHist.centers.map(x => x.toFixed(2)),
                        datasets: [{
                            label: 'Sample Data',
                            data: dataHist.bins,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Density', font: { size: 11 } }
                            },
                            x: {
                                title: { display: true, text: 'Data Value', font: { size: 11 } },
                                ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 } }
                            }
                        }
                    }
                });
                sampleCharts.push(dataChart);

                // Create chart
                const ctx = document.getElementById(`sampleChart${s}`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: bootHist.centers.map(x => x.toFixed(3)),
                        datasets: [{
                            label: 'Bootstrap Distribution',
                            data: bootHist.bins,
                            backgroundColor: 'rgba(126, 34, 206, 0.6)',
                            borderColor: '#7e22ce',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Density' }
                            },
                            x: {
                                title: { display: true, text: 'Statistic Value' }
                            }
                        }
                    }
                });
                sampleCharts.push(chart);

                // Display sample statistics
                const bootMean = mean(bootstrapStats);
                const bootSD = sd(bootstrapStats);

                const statsHTML = `
                    <div class="stats-row">
                        <span class="stats-label">Sample Statistic:</span>
                        <span class="stats-value">${sampleStat.toFixed(4)}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Bootstrap Mean:</span>
                        <span class="stats-value">${bootMean.toFixed(4)}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Bootstrap SE:</span>
                        <span class="stats-value">${bootSD.toFixed(4)}</span>
                    </div>
                `;
                document.getElementById(`sampleStats${s}`).innerHTML = statsHTML;
            }
        }

        function reset() {
            if (trueSamplingChart) {
                trueSamplingChart.data.labels = [];
                trueSamplingChart.data.datasets[0].data = [];
                trueSamplingChart.update();
            }

            document.getElementById('trueStats').innerHTML = '';
            document.getElementById('sampleCharts').innerHTML = '';
            sampleCharts = [];
        }

        window.onload = function() {
            updateDynamicInputs();
            document.getElementById('distribution').addEventListener('change', updateDynamicInputs);
        };
    </script>
</body>
</html>
